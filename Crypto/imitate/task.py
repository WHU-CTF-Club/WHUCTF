from Crypto.Util.number import getPrime, bytes_to_long, inverse
from base64 import b64encode
from secret import flag, a, b


def b64urlEncode(data):
    return b64encode(data).replace(b'+', b'-').replace(b'/', b'_').replace(b'=', b'')


class JWT_RS256:
    def __init__(self):
        self.p = getPrime(256)
        self.q = getPrime(256)
        self.n = self.p * self.q
        self.e = 0x10001
        self.d = inverse(self.e, (self.p - 1) * (self.q - 1))
        self.Mod = getPrime(1024)
        self.gift = (self.d * self.n * self.e) % self.Mod
        print(f'gift = {self.gift}')
        print(f'Mod = {self.Mod}')

    def encode(self, data: bytes):
        HEADER = b'{"alg":"RS256","typ":"JWT"}'
        PAYLOAD = data
        HEADER = b64urlEncode(HEADER)
        to_sig = bytes_to_long(PAYLOAD)
        PAYLOAD = b64urlEncode(PAYLOAD)
        SIGNATURE = pow(to_sig, self.d, self.n)
        SIGNATURE = hex(SIGNATURE)[2:]
        SIGNATURE = b64urlEncode(SIGNATURE.encode())
        return HEADER + b'.' + PAYLOAD + b'.' + SIGNATURE


jwt = JWT_RS256()

Ca = jwt.encode(a)
Cb = jwt.encode(b)

C = (jwt.p * bytes_to_long(flag)) % jwt.Mod

print(f'Ca = {Ca}')
print(f'Cb = {Cb}')
print(f'C = {C}')


# gift = 62385476978700501214089568185195649659274934363059744211931165834781435414849228446978742796363227760030554566402307253032004623212196365620974775430516021958860747745193274456246017264262999271411031601011550197243951058824991129679927663692540286012424727260428137908706271075996269463132650147692707777400
# Mod = 139783530492499989366806186190970201707045784617955510994670668264365125613780534146207604662234972781205415792315794694804125806787962550504358642185835486015743979918457538944006966377376366330483194448343751231567467051085883090503081476738133080325775972135216360160821424559840800702984626714613403410341
# Ca = b'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.TWF5YjM.NGI5N2IwYjUyY2Y0ZTlkMTJlZTFkNjhkYTE5MTRlZTUwY2UxOGRjMWViNGZkZDE5YWZiNDIzMGY3OWE2ZmI5YzQwNTI3ZGM1OGQ0OTIxZmI5ZWI3Zjc1ZGY2ZjBhZGI2MWU1YWQ1MWM4MjA4M2Y5M2IzZWZlZDVjZTM2YWRjNDQ'
# Cb = b'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.Q3J5cDc.MWJjNTI4NDIzNGU2MjgxZmY4ZDY4YmUwZTNmMWM3ZmQ0OTNmNDAwMDMzNTkyMjRmNjcwOWVmZTM0MjM2OGM0ZDc5ZDBmNTYwYzAzZGQ4ZDU4ZDRhNjk2NzU1MDU3NjVlZDBjNTgwOWJkMjViZWZlNTlmODY3NTZkYzI0NmJmZg'
# C = 3454932108453579916131399430502511588230619545318881430991349901038902611605453734080149058230878714433909067049429244397457303301903246046075369382663670798080063018482644701084995319681682533608988693424511755031
